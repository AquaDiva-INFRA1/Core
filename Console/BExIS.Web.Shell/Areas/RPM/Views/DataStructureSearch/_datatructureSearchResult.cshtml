@using Telerik.Web.Mvc.UI

@using BExIS.Web.Shell.Areas.RPM.Models
@model string

@{Html.Telerik().Grid<DataStructureResultStruct>()
                .Name("bx-rpm-dataStructureResultGrid")
                .HtmlAttributes(new { @class = "bx-rpm-resultGrid" })
                .DataBinding(dataBinding => dataBinding
                    .Ajax()
                    .Select("_dataStructureResultGridBinding", "DataStructureSearch", new { area = "RPM", searchTerms = Model })
                )
                .ClientEvents(e =>
                {
                    e.OnDataBinding("dataStructureResultGrid_onDataBinding");
                    e.OnDataBound("dataStructureResultGrid_onDataBound");
                })
                .Filterable()
                .Sortable()
                .Columns(columns =>
                {
                    columns.Bound(c => c.Id)
                        .Width(100);
                    columns.Bound(c => c.Title);
                    columns.Bound(c => c.Description);
                    columns.Template(
                    @<text>
                    </text>
                    )
                        .HeaderHtmlAttributes(new { @class = "bx-rpm-gridfunction" });
                })
                .ClientRowTemplate(
                    "<tr class='bx-rpm-datastructure-item' id='<#= Id #>' value='<#= Id #>, \"<#= Title #>\", \"<#= Description #>\", <#= inUse #>' structured='<#= Structured #>' inuse='<#= inUse #>'>" +
                      "<td class='bx-rpm-result id'><#= Id #></td>" +
                      "<td class='bx-rpm-result'><span class='bx-rpm-title clickable' id='<#= Id #>_title' onclick='javascript:clickDatastructure(<#= Id #>)'><#= Title #><span id='<#= Id #>_collapse' class='bx bx-angle-double-down'></span></span></td>" +
                      "<td class='bx-rpm-result'><#= Description #></td>" +
                      "<td class='bx-rpm-result bx-rpm-gridfunction'>" +
                          "<a id='<#= Id #>_edit' class='bx bx-grid-function bx-edit' href='/RPM/DataStructureEdit?dataStructureId=<#= Id #>'></a>" +
                          "<a id='<#= Id #>_download' class='bx bx-grid-function bx-download' href='/RPM/DataStructureIO/downloadTemplate?id=<#= Id #>'></a>" +
                          "<a id='<#= Id #>_delete' class='bx bx-grid-function bx-trash' href='javascript:openDelWindow(<#= Id #>, \"<#= Title #>\")'></a>" +
                      "</td>" +
                  "</tr>" +
                  "<tr class='bx-rpm-preview hidden' id ='<#= Id #>_preview' preview='<#= Preview #>'>" +
                      "<td colspan='3' id='<#= Id #>_content'>" +
                        "<h3 class='bx-rpm-loading'><span class='fa fa-spinner fa-pulse'></span> Loading Data Structure</h3>" +
                      "</td>" +
                  "</tr>" +
                  "<tr>" +
                      "<td class='bx-rpm-empty'></td>" +
                      "<td class='bx-rpm-empty'></td>" +
                      "<td class='bx-rpm-empty'></td>" +
                      "<td class='bx-rpm-empty bx-rpm-gridfunction'></td>" +
                  "</tr>"
                )
                .Render();
}

<script type="text/javascript">

    var previewIds = [];

    //open DataStructure preview
    function clickDatastructure(id) {
        if ($('#' + id + '_preview').attr('preview') == 'true') {
            $('#' + id + '_preview').attr('preview', 'false');
            $('#' + id + '_preview').addClass('hidden');
            $('#' + id + '_collapse').addClass('bx-angle-double-down');
            $('#' + id + '_collapse').removeClass('bx-angle-double-up');
            previewIds.splice(previewIds.indexOf(id), 1);
        }
        else {
            if ($('#' + id + '_preview #' + id +'_dataStructurePreviewGrid').length == 0) {
                loadPreview(id);
            }
            $('#' + id + '_preview').attr('preview', 'true');
            $('#' + id + '_preview').removeClass('hidden');
            $('#' + id + '_collapse').addClass('bx-angle-double-up');
            $('#' + id + '_collapse').removeClass('bx-angle-double-down');
            previewIds.push(id);
        }
        previewIds.sort();
    }

    function dataStructureResultGrid_onDataBinding(e) {
        e.data = {
            previewIds: previewIds
        };
    }

    function dataStructureResultGrid_onDataBound(e) {
        resetAllTelerikIconTitles();

        for (i = 0; i < $('.bx-rpm-datastructure-item').length; i++) {
            var id = $('.bx-rpm-datastructure-item')[i].id;
            //prepare UI for UnStructuredDataStructure
            if ($('#' + id).attr('structured') == 'false') {
                $('#' + id + '_download').addClass('bx-disabled');
                $('#' + id + '_download').removeAttr('href');
                $('#' + id + '_edit').attr('href', 'javascript:openCreateWindow(' + $('.bx-rpm-datastructure-item')[i].getAttribute('value') + ')');
                $('#' + id + '_title').removeAttr('onclick');
                $('#' + id + '_title').removeClass('clickable');
                $('#' + id + '_collapse').remove();
            }
            //prepare UI for locked DataStructure
            if ($('#' + id).attr('inuse') == 'true') {
                $('#' + id + '_delete').addClass('bx-disabled');
                $('#' + id + '_delete').removeAttr('href');
            }
        }

        //prepare UI for DataStructure preview
        for (i = 0; i < previewIds.length; i++) {
            if ($('#' + previewIds[i] + '_preview').attr('preview') == 'true') {
                loadPreview(previewIds[i]);
                $('#' + previewIds[i] + '_preview').removeClass('hidden');
                $('#' + previewIds[i] + '_collapse').addClass('bx-angle-double-up');
                $('#' + previewIds[i] + '_collapse').removeClass('bx-angle-double-down');
            }
        }
    }

    function dataStructurePreviewGrid_onDataBound(e) {
        resetAllTelerikIconTitles();
    }

    function loadPreview(id) {
        var parameters = '/?dataStructureId=' + id + '&structured=' + $('#' + id).attr('structured');
        $.get('@Url.Action("_dataStructurePreviewBinding", "DataStructureSearch", new { area = "RPM"} )' + parameters, function (data) {
            $('#' + id + '_content').html(data);
        });
    }

    function openDelWindow(id, name) {
        var title = 'Delete DataStructure ' + name + ' (' + id + ')';
        var parameters = '/?Id=' + id;

        $.ajax({
            type: 'GET',
            url: '@Url.Action("_deleteDataStructureBinding", "DataStructureSearch")' + parameters,
            dataType: 'html',
            success: function (data) {
                var windowElement = $.telerik.window.create({
                    title: title,
                    html: data,
                    contentUrl: "",
                    actions: ["Close"],
                    modal: true,
                    resizable: false,
                    draggable: true,
                    scrollable: false,
                    onClose: function () {
                        $("#windowDelete").data('tWindow').destroy();
                        $("#bx-rpm-dataStructureResultGrid .t-refresh").trigger('click');
                    }
                });

                windowElement.attr('id', 'windowDelete');
                var window = $(windowElement).data('tWindow');
                window.center().open();

                resetAllTelerikIconTitles();
            }
        });
    }

    function deleteMessageCancel() {
        $("#windowDelete").data('tWindow').destroy();
        $("#bx-rpm-dataStructureResultGrid .t-refresh").trigger('click');
    }

    function deleteMessageYes(id) {
        var parameters = '/?Id=' + id;
        $.get('@Url.Action("deleteDataStructure", "DataStructureSearch")' + parameters, function (data) {
            if ($(data).hasClass('bx-rpm-message') && $(data).attr('value').toLowerCase() == 'true') {
                $(data).replaceWith('.bx-rpm-message #' + id);
            }
            else if ($(data).hasClass('bx-rpm-message') && $(data).attr('id') == 'deleted') {
                $("#windowDelete").data('tWindow').destroy();
                $("#bx-rpm-dataStructureResultGrid .t-refresh").trigger('click');
            }
        });

    }

</script>