@using Telerik.Web.Mvc.UI

@using BExIS.Web.Shell.Areas.RPM.Models
@model string

@{Html.Telerik().Grid<DataStructureResultStruct>()
                .Name("bx-rpm-dataStructureResultGrid")
                .HtmlAttributes(new { @class = "bx-rpm-resultGrid" })
                .DataBinding(dataBinding => dataBinding
                    .Ajax()
                    .Select("_dataStructureResultGridBinding", "DataStructureSearch", new { area = "RPM", searchTerms = Model })
                )
                .ClientEvents(e =>
                {
                    e.OnDataBinding("dataStructureResultGrid_onDataBinding");
                    e.OnDataBound("dataStructureResultGrid_onDataBound");
                })
                .Filterable()
                .Sortable()
                .Columns(columns =>
                {
                    columns.Bound(c => c.Title);
                    columns.Template(
                    @<text>
                    </text>
                    )
                    .Title("Locked")
                    .HeaderHtmlAttributes(new { @class = "bx-rpm-lock" });
                    columns.Bound(c => c.Id);
                    columns.Bound(c => c.Description);
                    columns.Template(
                    @<text>
                    </text>
                    )
                    .HeaderHtmlAttributes(new { @class = "bx-rpm-gridfunction" });
                })
                .ClientRowTemplate(
                    "<tr class='bx-rpm-datastructure-item' id='<#= Id #>' structured='<#= Structured #>' inuse='<#= inUse #>'>" +
                      "<td class='bx-rpm-result'><span class='bx-rpm-title' onclick='javascript:clickDatastructure(<#= Id #>)'><#= Title #><span id='<#= Id #>_collapse' class='bx bx-angle-double-down'></span></span></td>" +
                      "<td class='bx-rpm-result bx-rpm-lock'><span id='<#= Id #>_lock'></span></td>" +
                      "<td class='bx-rpm-result'><#= Id #></td>" +
                      "<td class='bx-rpm-result'><#= Description #></td>" +
                      "<td class='bx-rpm-result bx-rpm-gridfunction'>" +
                          "<a class='bx bx-grid-function bx-edit' href='/RPM/DataStructureEdit?dataStructureId=<#= Id #>'></a>" +
                          "<a id='<#= Id #>_download' class='bx bx-grid-function bx-download' href='/RPM/DataStructureIO/downloadTemplate?id=<#= Id #>'></a>" +
                      "</td>" +
                  "</tr>" +
                  "<tr class='bx-rpm-preview hidden' id='<#= Id #>_preview' preview='<#= Preview #>'>" +
                      "<td colspan='4' id='<#= Id #>_content'>" +
                        "<h3 class='bx-rpm-loading'><span class='fa fa-spinner fa-pulse'></span> Loading Data Structure</h3>" +
                      "</td>" +
                  "</tr>" +
                  "<tr>" +
                      "<td class='bx-rpm-empty'></td>" +
                      "<td class='bx-rpm-empty bx-rpm-lock'></td>" +
                      "<td class='bx-rpm-empty'></td>" +
                      "<td class='bx-rpm-empty'></td>" +
                      "<td class='bx-rpm-empty bx-rpm-gridfunction'></td>" +
                  "</tr>"
                )
                .Render();
}

<script type="text/javascript">

    var previewIds = [];

    function clickDatastructure(id) {
        if ($('#' + id + '_preview').attr('preview') == 'true') {
            $('#' + id + '_preview').attr('preview', 'false');
            $('#' + id + '_preview').addClass('hidden');
            $('#' + id + '_collapse').addClass('bx-angle-double-down');
            $('#' + id + '_collapse').removeClass('bx-angle-double-up');
            previewIds.splice(previewIds.indexOf(id), 1);
        }
        else {
            if ($('#' + id + '_preview #' + id +'_dataStructurePreviewGrid').length == 0) {
                loadPreview(id);
            }
            $('#' + id + '_preview').attr('preview', 'true');
            $('#' + id + '_preview').removeClass('hidden');
            $('#' + id + '_collapse').addClass('bx-angle-double-up');
            $('#' + id + '_collapse').removeClass('bx-angle-double-down');
            previewIds.push(id);
        }
        previewIds.sort();
    }

    function dataStructureResultGrid_onDataBinding(e) {
        e.data = {
            previewIds: previewIds
        };
    }

    function dataStructureResultGrid_onDataBound(e) {
        resetAllTelerikIconTitles();

        for (i = 0; i < $('.bx-rpm-datastructure-item').length; i++) {
            var id = $('.bx-rpm-datastructure-item')[i].id;
            if ($('#' + id).attr('structured') == 'false') {
                $('#' + id + '_download').addClass('bx-disabled');
                $('#' + id + '_download').removeAttr('href');
            }
            if ($('#' + id).attr('inuse') == 'true') {
                $('#' + id + '_lock').addClass('bx bx-lock');
            }
        }

        for (i = 0; i < previewIds.length; i++) {
            if ($('#' + previewIds[i] + '_preview').attr('preview') == 'true') {
                loadPreview(previewIds[i]);
                $('#' + previewIds[i] + '_preview').removeClass('hidden');
                $('#' + previewIds[i] + '_collapse').addClass('bx-angle-double-up');
                $('#' + previewIds[i] + '_collapse').removeClass('bx-angle-double-down');
            }
        }
    }

    function dataStructurePreviewGrid_onDataBound(e) {
        resetAllTelerikIconTitles();
    }

    function loadPreview(id) {
        var parametrs = '/?dataStructureId=' + id + '&structured=' + $('#' + id).attr('structured')
        $.get('@Url.Action("_dataStructurePreviewBinding", "DataStructureSearch", new { area = "RPM"} )' + parametrs, function (data) {
            $('#' + id + '_content').html(data);
        });
    }

</script>