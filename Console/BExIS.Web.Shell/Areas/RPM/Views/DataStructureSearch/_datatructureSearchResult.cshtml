@using Telerik.Web.Mvc.UI

@using BExIS.Web.Shell.Areas.RPM.Models
@model string

@{Html.Telerik().Grid<DataStructureResultStruct>()
                .Name("bx-rpm-dataStructureResultGrid")
                .HtmlAttributes(new { @class = "bx-rpm-resultGrid" })
                .DataBinding(dataBinding => dataBinding
                    .Ajax()
                    .Select("_dataStructureResultGridBinding", "DataStructureSearch", new { area = "RPM", searchTerms = Model })
                )
                .ClientEvents(e =>
                {
                    e.OnDataBinding("dataStructureResultGrid_onDataBinding");
                    e.OnDataBound("dataStructureResultGrid_onDataBound");
                })
                .Filterable()
                .Sortable(sorting => sorting.OrderBy(sortOrder => sortOrder.Add(c => c.Title)))
                .Columns(columns =>
                {
                    columns.Bound(c => c.Id)
                        .Width(100);
                    columns.Bound(c => c.Title);
                    columns.Bound(c => c.Description);
                    columns.Template(
                    @<text>
                    </text>
                    )
                        .HeaderHtmlAttributes(new { @class = "bx-rpm-gridfunction" });
                })
                .ClientRowTemplate(
                    "<tr class='bx-rpm-datastructure-item' id='<#= Id #>' value='<#= Id #>, \"<#= Title #>\", \"<#= Description #>\", <#= Structured #>, <#= inUse #>' structured='<#= Structured #>' inuse='<#= inUse #>'>" +
                      "<td class='bx-rpm-result id'><#= Id #></td>" +
                      "<td class='bx-rpm-result'><span class='bx-rpm-title clickable' id='<#= Id #>_title' onclick='javascript:clickDatastructure(<#= Id #>)'><#= Title #><span id='<#= Id #>_collapse' class='bx bx-angle-double-down'></span></span></td>" +
                      "<td class='bx-rpm-result'><#= Description #></td>" +
                      "<td class='bx-rpm-result bx-rpm-gridfunction'>" +
                          "<a id='<#= Id #>_edit' class='bx bx-grid-function bx-edit' href='/RPM/DataStructureEdit/?dataStructureId=<#= Id #>'></a>" +
                          "<a id='<#= Id #>_download' class='bx bx-grid-function bx-download' href='/RPM/DataStructureIO/downloadTemplate?id=<#= Id #>'></a>" +
                          "<a id='<#= Id #>_copy' class='bx bx-grid-function bx-copy' href='javascript:openCreateWindow(<#= Id #>, \"<#= Title #>\", \"<#= Description #>\", <#= Structured #>, <#= inUse #>, true)'></a>" +
                          //"<a id='<#= Id #>_delete' class='bx bx-grid-function bx-trash' href='javascript:openDelWindow(<#= Id #>, \"<#= Title #>\")'></a>" +
                      "</td>" +
                  "</tr>" +
                  "<tr class='bx-rpm-preview bx-rpm-hidden' id ='<#= Id #>_preview' preview='<#= Preview #>'>" +
                      "<td colspan='3' id='<#= Id #>_content'>" +
                        "<h3 class='bx-rpm-loading'><span class='fa fa-spinner fa-pulse'></span> Loading Data Structure</h3>" +
                      "</td>" +
                  "</tr>" +
                  "<tr>" +
                      "<td class='bx-rpm-empty'></td>" +
                      "<td class='bx-rpm-empty'></td>" +
                      "<td class='bx-rpm-empty'></td>" +
                      "<td class='bx-rpm-empty bx-rpm-gridfunction'></td>" +
                  "</tr>"
                )
                .Render();
}

<script type="text/javascript">

    var previewIds = [];

    //open DataStructure preview
    function clickDatastructure(id) {
        if ($('#' + id + '_preview').attr('preview') == 'true') {
            $('#' + id + '_preview').attr('preview', 'false');
            previewIds.splice(previewIds.indexOf(id), 1);
        }
        else {
            if ($('#' + id + '_preview #' + id +'_dataStructurePreviewGrid').length == 0) {
                loadPreview(id);
            }
            $('#' + id + '_preview').attr('preview', 'true');
            previewIds.push(id);

        }
        $('#' + id + '_collapse').toggleClass('bx-angle-double-down');
        $('#' + id + '_collapse').toggleClass('bx-angle-double-up');
        $('#' + id + '_preview').fadeToggle('fast');
        previewIds.sort();
    }

    function dataStructureResultGrid_onDataBinding(e) {
        e.data = {
            previewIds: previewIds
        };
    }

    function dataStructureResultGrid_onDataBound(e) {
        resetAllTelerikIconTitles();
        addTooltips();

        for (i = 0; i < $('.bx-rpm-datastructure-item').length; i++) {
            var id = $('.bx-rpm-datastructure-item')[i].id;
            //prepare UI for UnStructuredDataStructure
            if ($('#' + id).attr('structured') == 'false') {
                $('#' + id + '_download').addClass('bx-disabled');
                $('#' + id + '_download').removeAttr('href');
                $('#' + id + '_edit').attr('href', 'javascript:openCreateWindow(' + $('.bx-rpm-datastructure-item')[i].getAttribute('value') + ', false)');
                $('#' + id + '_title').removeAttr('onclick');
                $('#' + id + '_title').removeClass('clickable');
                $('#' + id + '_collapse').remove();
            }
            //prepare UI for locked DataStructure
            if ($('#' + id).attr('inuse') == 'true' && $('#' + id).attr('structured') == 'true') {
                $('#' + id + '_edit').removeClass('bx-edit');
                $('#' + id + '_edit').addClass('bx-show');
            }
        }

        //prepare UI for DataStructure preview
        for (i = 0; i < previewIds.length; i++) {

            if ($('#' + previewIds[i] + '_preview').attr('preview') == 'true') {
                loadPreview(previewIds[i]);
                $('#' + previewIds[i] + '_preview').fadeToggle('fast');
                $('#' + previewIds[i] + '_collapse').toggleClass('bx-angle-double-down');
                $('#' + previewIds[i] + '_collapse').toggleClass('bx-angle-double-up');
            }
        }
    }

    function dataStructurePreviewGrid_onDataBound(e) {
        resetAllTelerikIconTitles();
        addTooltips();
    }

    function loadPreview(id) {
        var parameters = '/?dataStructureId=' + id + '&structured=' + $('#' + id).attr('structured');
        $.get('@Url.Action("_dataStructurePreviewBinding", "DataStructureSearch", new { area = "RPM"} )' + parameters, function (data) {
            $('#' + id + '_content').html(data);
        });
    }

    function copyDatastructure(id, name){
        var parameters = '/?Id=' + id + '&Name=&isStructured=' + $('#' + id).attr('structured');
        $.get('@Url.Action("_copyDataStructure", "DataStructureSearch", new { area = "RPM"} )' + parameters, function (data) {
            console.log(data);
            if ($(data).hasClass('bx-rpm-message') && $(data).attr('id') == 'redirect' || $(data).hasClass('bx-rpm-message') && $(data).attr('id') == 'refresh') {
                $("#bx-rpm-dataStructureResultGrid .t-refresh").trigger('click');
            }
        });
    }
</script>