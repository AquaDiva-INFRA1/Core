@using System.Linq.Expressions
@using BExIS.Modules.Sam.UI.Models
@using Telerik.Web.Mvc
@using Telerik.Web.Mvc.Extensions
@using Telerik.Web.Mvc.UI

@section Information
{
    With this interface you are able to manage groups. New groups can be added with the "Create" button. Existing groups can be edited (properties, members, delete) using the "Edit" button.
    <p>
        <a href="/SAM/Help/Index/#_Toc451422047" class="bx-informationLink" title="go to help" target="_blank">More</a>
    </p>
}

@Html.ActionLink("Create Group", "Create", "Groups", null, new { @class = "bx-button function" })

@(Html.Telerik().Grid<GroupGridRowModel>()
      .Name("gridGroups")
      .Columns(columns =>
      {
          columns.Bound(g => g.Id);
          columns.Bound(g => g.GroupName);
          columns.Bound(g => g.GroupType);
          columns.Bound(g => g.Description);
          columns.Template(@<text>
                               <button type="button" class="bx bx-grid-function bx-edit"></button>
                               <button type="button" class="bx bx-grid-function bx-trash"></button>
                            </text>)
              .ClientTemplate(
                  "<button type=\"button\" class=\"bx bx-grid-function bx-edit\" value=\"<#= Id #>\"></button>" +
                  "<button type=\"button\" class=\"bx bx-grid-function bx-trash\" value=\"<#= Id #>\"></button>")
              .Width(70);
      })
      .ClientEvents(events =>
      {
          events.OnDataBound("onDataBound");
      })
      .DataBinding(dataBinding => dataBinding
          .Ajax()
          .OperationMode(GridOperationMode.Client)
          .Select("Groups_Select", "Groups")
      )
      .EnableCustomBinding(true)
      .Filterable()
      .Pageable(pageable =>
      {
          pageable.PageSize(10, new[] { 10, 20, 50, 100 });
          pageable.Style(GridPagerStyles.NextPreviousAndNumeric | GridPagerStyles.PageSizeDropDown);
          pageable.Position(GridPagerPosition.Bottom);
      })
      .Sortable(sortable => sortable.OrderBy(order => order.Add(c => c.Id).Descending())))

@section Scripts
{
    <script src="@Url.Content("~/Scripts/2013.2.611/telerik.common.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/2013.2.611/telerik.draganddrop.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/2013.2.611/telerik.window.min.js")" type="text/javascript"></script>

    <script type="text/javascript">

        function onDataBound() {
            addTooltips();
            resetAllTelerikIconTitles();

            $('.bx-edit')
                            .click(function () {
                                $.ajax({
                                    type: 'GET',
                                    url: '@Url.Action("Update", "Groups")',
                                    data: { GroupId: $(this).attr("value") },
                                    dataType: 'html',
                                    success: function (htmlData) {
                                        var windowElement = $.telerik.window.create({
                                            title: "Update Group (Id: " + $(this).attr("value") + ")",
                                            html: "<div id='contentUpdate' class='bx-window'>" + htmlData + "</div>",
                                            contentUrl: "",
                                            actions: ["Close"],
                                            modal: true,
                                            width: 500,
                                            height: 500,
                                            resizable: false,
                                            draggable: true,
                                            scrollable: false,
                                            onClose: function () {
                                                $("#windowUpdate").data('tWindow').destroy();
                                                $("#gridGroups .t-refresh").trigger('click');
                                            }
                                        });

                                        windowElement.attr('id', 'windowUpdate');
                                        var window = $(windowElement).data('tWindow');
                                        window.center().open();

                                        resetAllTelerikIconTitles();
                                    }
                                });
                            });

            $('.bx-trash')
                .click(function() {
                    alert($(this).attr("value"));
                });
        }

        $("input[name='selectedUsers']").click(function () {
            var rows = $("#gridUserMemberships").data("tGrid").data;

            for (var i = 0; i < rows.length; ++i) {
                if (rows[i].Id == $(this).attr('value')) {
                    rows[i].IsUserInGroup = $(this).is(':checked');
                }
            }
        });
    </script>
}