@using BExIS.Modules.Sam.UI.Models
@using Telerik.Web.Mvc
@using Telerik.Web.Mvc.UI
<style>
    .t-window-content {
        height: auto !important;
        width: auto !important;
    }

    #gridMemberships {
        width: 80vw !important;
    }
</style>

@section Information
{
    With this interface you are able to manage users. New users can be added with the "Create" button. Existing users can be edited (properties, memberships, delete) through the "Edit" button.
    <p>
        <a href="/SAM/Help/Index/#_Toc451422044" class="bx-informationLink" title="go to help" target="_blank">More</a>
    </p>
}
<button id="button_createuser" type="button" class="bx-button function">Create User</button>
@(Html.Telerik().Grid<UserGridRowModel>().Name("gridUsers")
    .Columns(columns =>
    {
        columns.Bound(u => u.Id);
        columns.Bound(u => u.UserName);
        columns.Bound(u => u.Email);
        columns.Bound(u => u.IsAdministrator);
        columns.Template(@<text>
        <button type="button" class="bx bx-grid-function bx-edit"></button>
        <button type="button" class="bx bx-grid-function bx-group"></button>
        <button type="button" class="bx bx-grid-function bx-trash"></button>
        </text>)
        .ClientTemplate(
            "<button type=\"button\" class=\"bx bx-grid-function bx-edit\" value=\"<#= Id #>\"></button>" +
            "<button type=\"button\" class=\"bx bx-grid-function bx-group\" value=\"<#= Id #>\"></button>" +
            "<button type=\"button\" class=\"bx bx-grid-function bx-trash\" value=\"<#= Id #>\"></button>")
        .Width(110);
    })
    .ClientEvents(events =>
    {
        events.OnDataBound("onDataBound");
    })
    .DataBinding(dataBinding => dataBinding
        .Ajax()
        .Select("Users_Select", "Users")
    )
    .EnableCustomBinding(true)
    .Filterable()
    .Pageable(pageable =>
    {
        pageable.PageSize(10, new[] { 10, 20, 50, 100 });
        pageable.Style(GridPagerStyles.NextPreviousAndNumeric | GridPagerStyles.PageSizeDropDown);
        pageable.Position(GridPagerPosition.Bottom);
    })
    .Sortable())
@section Scripts
{
    <script src="@Url.Content("~/Scripts/2013.2.611/telerik.common.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/2013.2.611/telerik.draganddrop.min.js")" type="text/javascript"></script>
    <script src="@Url.Content("~/Scripts/2013.2.611/telerik.window.min.js")" type="text/javascript"></script>

    <script type="text/javascript">

    $('#button_createuser')
        .click(function() {
            $.ajax({
                type: 'GET',
                url: '@Url.Action("Create", "Users")',
                dataType: 'html',
                success: function(htmlData) {
                    var windowElement = $.telerik.window.create({
                        title: "Create User",
                        html: "<div id='contentCreate' class='bx-window'>" + htmlData + "</div>",
                        contentUrl: "",
                        actions: ["Close"],
                        modal: true,
                        width: 500,
                        height: 500,
                        resizable: false,
                        draggable: true,
                        scrollable: false,
                        onClose: function() {
                            $("#windowCreate").data('tWindow').destroy();
                            $("#gridUsers .t-refresh").trigger('click');
                        }
                    });

                    windowElement.attr('id', 'windowCreate');
                    var window = $(windowElement).data('tWindow');
                    window.center().open();

                    resetAllTelerikIconTitles();
                }
            });
        });

    function getSelection() {
        var selection = [];

        $("input[name='selectedGroups']").each(function(){
            selection.push({
                key: $(this).attr('value'),
                value: false
            });
        });

        $("input[name='selectedGroups']:checked").each(function () {
            selection.push({
                key: $(this).attr('value'),
                value: true
            });
        });

        return selection;
    }

        function onDataBinding(e) {
            e.data =
            {
                selection: getSelection()
            };
        }

        function onDataBound() {
            addTooltips();
            resetAllTelerikIconTitles();

            $('.bx-edit')
                .click(function () {
                    $.ajax({
                        type: 'GET',
                        url: '@Url.Action("Update", "Users")',
                        data: { UserId: $(this).attr("value") },
                        dataType: 'html',
                        success: function (htmlData) {
                            var windowElement = $.telerik.window.create({
                                title: "Update User (Id: " + $(this).attr("value") + ")",
                                html: "<div id='contentUpdate' class='bx-window'>" + htmlData + "</div>",
                                contentUrl: "",
                                actions: ["Close"],
                                modal: true,
                                width: 500,
                                height: 500,
                                resizable: false,
                                draggable: true,
                                scrollable: false,
                                onClose: function () {
                                    $("#windowEdit").data('tWindow').destroy();
                                    $("#gridUsers .t-refresh").trigger('click');
                                }
                            });

                            windowElement.attr('id', 'windowUpdate');
                            var window = $(windowElement).data('tWindow');
                            window.center().open();

                            resetAllTelerikIconTitles();
                        }
                    });
                });

            $('.bx-trash')
                .click(function () {
                    $.ajax({
                        type: 'GET',
                        url: '@Url.Action("Update", "Users")',
                        data: { UserId: $(this).attr("value") },
                        dataType: 'html',
                        success: function (htmlData) {
                            var windowElement = $.telerik.window.create({
                                title: "Update User: " + username + " (Id: " + id + ")",
                                html: "<div id='contentUpdate' class='bx-window'>" + htmlData + "</div>",
                                contentUrl: "",
                                actions: ["Close"],
                                modal: true,
                                width: 500,
                                height: 500,
                                resizable: false,
                                draggable: true,
                                scrollable: false,
                                onClose: function () {
                                    $("#windowEdit").data('tWindow').destroy();
                                    $("#gridUsers .t-refresh").trigger('click');
                                }
                            });

                            windowElement.attr('id', 'windowUpdate');
                            var window = $(windowElement).data('tWindow');
                            window.center().open();

                            resetAllTelerikIconTitles();
                        }
                    });
                });

            $('.bx-group')
    .click(function () {
        $.ajax({
            type: 'GET',
            url: '@Url.Action("Memberships", "Users")',
            data: { UserId: $(this).attr("value") },
            dataType: 'html',
            success: function (htmlData) {
                var windowElement = $.telerik.window.create({
                    title: "User Membership (Id: " + $(this).attr("value") + ")",
                    html: "<div id='contentMembership' class='bx-window'>" + htmlData + "</div>",
                    contentUrl: "",
                    actions: ["Close"],
                    modal: true,
                    width: 500,
                    height: 500,
                    resizable: false,
                    draggable: true,
                    scrollable: false,
                    onClose: function () {
                        $("#windowMembership").data('tWindow').destroy();
                        $("#gridUsers .t-refresh").trigger('click');
                    }
                });

                windowElement.attr('id', 'windowMembership');
                var window = $(windowElement).data('tWindow');
                window.center().open();

                resetAllTelerikIconTitles();
            }
        });
    });
        }
    </script>
}